<script src="resources/node_modules/jquery/dist/jquery.min.js"></script>

<script src="resources/sigma.min.js"></script>
<script src="resources/sigma.canvas.edgehovers.def.js"></script>
<script src="resources/sigma.renderers.edgeLabels.min.js"></script>

<script src="clickFunctionality.js"></script>

<script src="algorithms/dijkstra.js"></script>
<script src="algorithms/prims.js"></script>
<script src="algorithms/kruskal.js"></script>

<script src="teachers/dijsktraTeacher.js"></script>
<script src="teachers/kruskalTeacher.js"></script>
<script src="teachers/primsTeacher.js"></script>

<script src="tools/Tree.js"></script>
<script src="tools/Timer.js"></script>
<script src="resources/slideReveal.js"></script>

<link rel="stylesheet" href="resources/style.css">
<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
<link href="resources/bootstrap-tour/build/css/bootstrap-tour-standalone.css" rel="stylesheet">
<script src="resources/bootstrap-tour/build/js/bootstrap-tour-standalone.js"></script>
<script src="resources/node_modules/popup-validation/bin/validation.min.js"></script>
<link href="resources/node_modules/popup-validation/bin/validation.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="resources/style.css"/>

<html>
<head>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <title>Eman's Graph Tool</title>
</head>

<body id="base">

<div id="json-import">
    <span id="close-holder"><button id="close-button" onclick="closeJsonInput()">x</button></span>
    <form id="json-input">
        <label>Input
            <input type="text" id="json-text-input" name="json-input">
            <input type="submit" class="algo-button" id="json-submit-btn" onclick="parseJson()">
        </label>
    </form>
</div>

<div id="tour-anchor"></div>

<div id="hover-bar"></div>

<div id="slider">
    <div class="handle">
        <span id="trigger" class="glyphicon glyphicon-chevron-left"></span>
    </div>

    <div id="slider-header">
        <div id="slider-title">
            Control Panel
        </div>
        <div id="slider-info" class="btn glyphicon glyphicon-info-sign" onclick="runTourGuide()"></div>
    </div>

    <div class="btn-group algo-button-group" role="group" aria-label="Algo Button">
        <button type="button" class="algo-button algo-chooser-highlight" id="dijkstra-option"
                onclick="showDijkstraInputBoxes()">Dijkstra's
        </button>
        <button type="button" class="algo-button" id="kruskal-option" onclick="showKruskalInputBoxes()">Kruskal's
        </button>
        <button type="button" class="algo-button" id="prim-option" onclick="showPrimsInputBoxes()">Prim's</button>
    </div>

    <form name="source-target" id="node-id-input-box" class="input-box-holder" onsubmit="executedSelectedAlgorithm()">
        <div id="source-holder">
            Source Node
            <label>
                <input type="text" name="source-node" id="src-node" class="node-input validate-class my-class-invalid">
            </label>
            <div id="source-error-message" hidden>
                Invalid ID!
            </div>
        </div>

        <div id="button-block">
            <button class="algo-button" id="clear-button" onclick="clearGraph()">CLEAR GRAPH</button>
            <input type="submit" id="execute-button" class="algo-button" value="Execute">
        </div>
    </form>

    <button type="button" class="algo-button" id="json-import-btn" onclick="importJson()">Import Graph</button>
    <button type="button" class="algo-button" id="json-export-btn" onclick="exportJson()">Export Graph</button>
</div>

<div id="helper-text"></div>

<div id="media-holder">
    <span id="backward-button" class="glyphicon glyphicon-backward" onclick="rewindOneStep()"></span>
    <span id="play-button" class="glyphicon glyphicon-play" onclick="showPauseButton()"></span>
    <span id="pause-button" class="glyphicon glyphicon-pause" onclick="showPlayButton()"></span>
    <span id="forward-button" class="glyphicon glyphicon-forward" onclick="forwardOneStep()"></span>
</div>

</body>
<script>

    $("#src-node").focusout(function () {
        const srcNodeId = getNodeIdFromLabel($("#src-node").val());

        if (!srcNodeId) {
            document.getElementById("source-error-message").style.display = "inline";
            validNodeId = false;
        } else {
            document.getElementById("source-error-message").style.display = "none";
            validNodeId = true;
        }
    });

    //runTourGuide();
    let algorithmSelected = "dijkstra";
    let validNodeId = false;

    $("#hover-bar").mouseover(function () {
        $('#slider').slideReveal("show");
    });

    $("#slider").mouseleave(function () {
        $('#slider').slideReveal("hide");
    });


    function importJson() {
        document.getElementById("json-import").style.visibility = "visible";
    }

    function exportJson() {
        document.getElementById("json-import").style.visibility = "visible";

        let jsonGraphText = "{\"nodes\":";
        const nodes = [];

        s.graph.nodes().forEach(function (node) {
            const nodeCreation = {
                id: node.id,
                x: node.x.toString(),
                y: node.y.toString(),
            };

            nodes.push(nodeCreation);
        });
        jsonGraphText += JSON.stringify(nodes);
        jsonGraphText += ",\"edges\":";

        const edges = [];

        s.graph.edges().forEach(function (edge) {
            const edgeCreation = {
                id: edge.id,
                source: edge.source,
                target: edge.target,
            };

            edges.push(edgeCreation);
        });

        jsonGraphText += JSON.stringify(edges);
        jsonGraphText += "}";

        document.getElementById("json-text-input").value = jsonGraphText;
    }

    function closeJsonInput() {
        document.getElementById("json-import").style.visibility = "hidden";
    }

    function parseJson() {
        event.preventDefault();
        const jsonTextInput = document.getElementById("json-text-input").value;
        const textToJson = JSON.parse(jsonTextInput);

        clearGraph();

        for (let i = 0; i < textToJson.nodes.length; i++) {

            const nodeCreation = {
                id: textToJson.nodes[i].id,
                x: textToJson.nodes[i].x * 100,
                y: textToJson.nodes[i].y * 100,
                label: (i + 1).toString(),
                size: 10
            };

            s.graph.addNode(nodeCreation);
            s.refresh();
            closeJsonInput();
        }

        for (let i = 0; i < textToJson.edges.length; i++) {

            const edgeCreation = {
                id: createEdgeIdFromCoordinates(textToJson.edges[i].source, textToJson.edges[i].target),
                source: textToJson.edges[i].source,
                target: textToJson.edges[i].target,
                defaultEdgeLabelSize: 20,
                size: 3,
                label: textToJson.edges[i].weight
            };

            s.graph.addEdge(edgeCreation);
            s.refresh();
        }
    }

    function show() {
        //$('#slider').slideReveal("show");
        console.log("lolopl");
    }


    function showPlayButton() {
        document.getElementById("pause-button").style.display = "none";
        document.getElementById("play-button").style.display = "inline";

        pauseTimer();
    }

    function showPauseButton() {

        document.getElementById("play-button").style.display = "none";
        document.getElementById("pause-button").style.display = "inline";

        resumeTimer();
    }

    function rewindOneStep() {
        showPlayButton();
        rewindBack();
    }

    function forwardOneStep() {
        showPlayButton();
        forwardOne();
    }

    $('#slider').slideReveal({
        trigger: $("#trigger"),
        position: "right",
        push: false,
        overlay: true
    });

    function showDijkstraInputBoxes() {
        document.getElementById("source-holder").style.visibility = "visible";

        $(".algo-chooser-highlight").removeClass("algo-chooser-highlight");
        $('#dijkstra-option').addClass('algo-chooser-highlight');
        algorithmSelected = "dijkstra";
    }

    function showKruskalInputBoxes() {
        document.getElementById("source-holder").style.visibility = "hidden";

        $(".algo-chooser-highlight").removeClass("algo-chooser-highlight");
        $('#kruskal-option').addClass('algo-chooser-highlight');

        algorithmSelected = "kruskal";
    }

    function showPrimsInputBoxes() {
        document.getElementById("source-holder").style.visibility = "visible";

        $(".algo-chooser-highlight").removeClass("algo-chooser-highlight");
        $('#prim-option').addClass('algo-chooser-highlight');

        algorithmSelected = "prim";
    }


    $(document).bind("contextmenu", function (event) {
        event.preventDefault();
    });

    $(document).ondblclick = function (event) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    };

    const nodeColour = "#ff0e58";
    const edgeColour = "#ff0e58";

    const s = new sigma({
        renderer: {
            container: document.getElementById('base'),
            type: 'canvas'
        },
        settings: {
            borderSize: 3,

            defaultNodeColor: nodeColour,
            defaultNodeBorderColor: "#c9ddff",

            defaultEdgeColor: edgeColour,
            defaultEdgeLabelColor: edgeColour,
            defaultEdgeLabelSize: 20,

            defaultLabelColor: "#ffffff",
            defaultLabelHoverColor: "#ff0e58",
            labelHoverColor: "node",
            labelShadowColor: "#c9ddff",

            enableEdgeHovering: true,
            edgeHoverSizeRatio: 2,
            edgeHoverExtremities: true,
            autoRescale: false,
            mouseEnabled: true,
            doubleClickEnabled: false
        }
    });

    window.onload = function () {
        const storageNodes = JSON.parse(localStorage.getItem("nodes"));
        const storageEdges = JSON.parse(localStorage.getItem("edges"));

        if (storageNodes.length > 0) {
            storageNodes.forEach(function (node) {
                s.graph.addNode(node);
            });

            if (storageEdges.length > 0) {
                storageEdges.forEach(function (edge) {
                    s.graph.addEdge(edge);
                });
            }
            s.refresh();
        }
    };

    window.onbeforeunload = function () {
        clearColoredNodesAndEdges();
        localStorage.clear();

        localStorage.setItem("nodes", JSON.stringify(s.graph.nodes()));
        localStorage.setItem("edges", JSON.stringify(s.graph.edges()));
    };

    function createRandomGraph(quantityOfNodes) {
        clearGraph();

        s.settings('autoRescale', true);
        s.settings('mouseEnabled', false);

        let labelId = 0;

        const nodeIdSet = new Set();

        for (let i = 0; i < quantityOfNodes; i++) {

            const randomGeneratedX = Math.floor((Math.random() * 50));
            const randomGeneratedY = Math.floor((Math.random() * 50));

            const nodeId = createNodeIdFromCoordinates(randomGeneratedX, randomGeneratedY);

            if (!nodeIdSet.has(nodeId)) {
                s.graph.addNode({
                    id: createNodeIdFromCoordinates(randomGeneratedX, randomGeneratedY),
                    label: (labelId++).toString(),
                    x: randomGeneratedX,
                    y: randomGeneratedY,
                    size: 3
                });

                nodeIdSet.add(nodeId);
            }
        }

        const nodesOnGraph = s.graph.nodes();

        const edgeIdSet = new Set();

        for (let node of nodesOnGraph) {
            const pickRandomNodeToConnect = Math.floor(Math.random() * nodesOnGraph.length);

            const sourceNode = node;
            let targetNode = nodesOnGraph[pickRandomNodeToConnect];

            while (sourceNode === targetNode) {
                targetNode = nodesOnGraph[Math.floor(Math.random() * nodesOnGraph.length)];
            }

            const edgeId = createEdgeIdFromCoordinates(sourceNode.id, targetNode.id);

            if (!edgeIdSet.has(edgeId)) {
                s.graph.addEdge({
                    id: edgeId,
                    source: sourceNode.id,
                    target: targetNode.id,
                    defaultEdgeLabelSize: 20,
                    size: 3,
                    label: computePathLength(sourceNode, targetNode).toString()
                });

                edgeIdSet.add(edgeId);
            }
        }
        s.refresh();
    }

    function executedSelectedAlgorithm() {
        event.preventDefault();

        if (algorithmSelected === "dijkstra") {
            calculateDijkstraPath();

        } else if (algorithmSelected === "kruskal") {
            calculateKruskalPath();

        } else if (algorithmSelected === "prim") {
            calculatePrimsPath();
        }

        return false;
    }

    function calculateDijkstraPath() {
        clearColoredNodesAndEdges();

        if (validNodeId) {

            const srcNodeId = getNodeIdFromLabel($("#src-node").val());

            const path = s.graph.dijkstra(srcNodeId);
            executeDijkstraTeacher(path);

            $('#slider').slideReveal("hide");
            document.getElementById("play-button").style.display = "none";
            document.getElementById("pause-button").style.display = "inline";
        }
    }

    function calculateKruskalPath() {
        clearColoredNodesAndEdges();

        const idsOfMinSpanningTreeEdges = s.graph.kruskal();
        executeKruskalTeacher(idsOfMinSpanningTreeEdges);

        $('#slider').slideReveal("hide");
        document.getElementById("play-button").style.display = "none";
        document.getElementById("pause-button").style.display = "inline";
    }

    function calculatePrimsPath() {
        clearColoredNodesAndEdges();

        const srcNodeId = getNodeIdFromLabel($("#src-node").val());

        const edgesWithMinSpanTreeFlag = s.graph.prims(srcNodeId);
        executePrimsTeacher(edgesWithMinSpanTreeFlag);

        $('#slider').slideReveal("hide");
        document.getElementById("play-button").style.display = "none";
        document.getElementById("pause-button").style.display = "inline";
    }

    function clearGraph() {
        s.graph.clear();
        localStorage.clear();
        s.refresh();
    }

    function clearColoredNodesAndEdges() {
        s.graph.nodes().forEach(function (node) {
            node.color = nodeColour;
        });

        s.graph.edges().forEach(function (edges) {
            edges.color = nodeColour;
        });

        s.refresh();
    }

    function getNodeIdFromLabel(nodeId) {
        const node = s.graph.nodes().filter(function (node) {
            return node.label === nodeId;
        }).shift();

        return node ? node.id : null;
    }

    const createNodeIdFromCoordinates = function (x, y) {
        return x + '.' + y;
    };

    function createEdgeIdFromCoordinates(x, y) {
        return x + "|" + y;
    }

    function computePathLength(node1, node2) {
        return (Math.sqrt(Math.pow((node2.y - node1.y), 2) + Math.pow((node2.x - node1.x), 2)) / 10).toFixed(2);
    }

    function returnSortedEdgesByWeight() {
        return s.graph.edges().sort(function (a, b) {
            return a.label - b.label;
        });
    }

    function runTourGuide() {
        var tour = new Tour({
            steps: [
                {
                    template: "<div class='popover tour'>\n" +
                    "    <div class='popover-content'>Welcome to my Graph Algo Tool! This website will educate you on algorithms</div>\n" +
                    "    <div class='popover-navigation'>\n" +
                    "     <div id='options'>" +
                    "        <div class='glyphicon glyphicon-arrow-left directional-buttons' data-role='prev'></div>\n" +
                    "        <span data-role='separator'>|</span>\n" +
                    "        <div class='glyphicon glyphicon-arrow-right directional-buttons' data-role='next'></div>\n" +
                    "    </div>" +
                    "   </div>\n" +
                    "  </div>",
                    backdrop: true,
                    element: "#tour-anchor"
                }, {
                    template: "<div class='popover tour'>\n" +
                    "    <div class='popover-content'>Right click to insert node on screen. Left click to remove!</div>\n" +
                    "    <div class='popover-navigation'>\n" +
                    "     <div id='options'>" +
                    "        <div class='glyphicon glyphicon-arrow-left directional-buttons' data-role='prev'></div>\n" +
                    "        <span data-role='separator'>|</span>\n" +
                    "        <div class='glyphicon glyphicon-arrow-right directional-buttons' data-role='next'></div>\n" +
                    "    </div>" +
                    "   </div>\n" +
                    "  </div>",
                    backdrop: false,
                    element: "#tour-anchor",
                    onNext: show()
                }, {
                    element: "#trigger",
                    template: "<div class='popover tour'>\n" +
                    "    <div class='popover-content'>On the right is the control panel, from here is where the algorithms get executed. Hover cursor on the right to view.</div>\n" +
                    "    <div class='popover-navigation'>\n" +
                    "     <div id='options'>" +
                    "        <div class='glyphicon glyphicon-arrow-left directional-buttons' data-role='prev'></div>\n" +
                    "        <span data-role='separator'>|</span>\n" +
                    "        <div class='glyphicon glyphicon-arrow-right directional-buttons' data-role='next'></div>\n" +
                    "    </div>" +
                    "   </div>\n" +
                    "  </div>",
                    backdrop: true,
                }
            ]
        });

        tour.init();
        tour.start();
    }
</script>
</html>