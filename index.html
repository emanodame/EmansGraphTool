<script src="resources/node_modules/jquery/dist/jquery.min.js"></script>

<script src="resources/sigma.min.js"></script>
<script src="resources/sigma.canvas.edgehovers.def.js"></script>
<script src="resources/sigma.renderers.edgeLabels.min.js"></script>

<script src="clickFunctionality.js"></script>
<script src=dijkstra.js></script>


<link rel="stylesheet" href="index.css">

<html>

<head>
    <title>Eman's Graph Tool</title>
</head>
<body id="base">

<div>
    <form class="my-form">
        Source Node:<br>
        <input type="text" name="srcNode"><br>
        Dest Node:<br>
        <input type="text" name="destNode"><br><br>
        <input type="submit" value="Submit">
    </form>
</div>

<div>
    <button onclick="clearGraph()">CLEAR GRAPh</button>
</div>

<script>

    const s = new sigma({
        renderer: {
            container: document.getElementById('base'),
            type: 'canvas'
        },
        settings: {
            borderSize: 3,

            defaultNodeBorderColor: "#c9ddff",
            defaultEdgeLabelSize: 20,

            defaultLabelHoverColor: "#FFFFFF",
            labelHoverColor: "node",
            labelShadowColor: "#c9ddff",

            enableEdgeHovering: true,
            edgeHoverSizeRatio: 2,
            edgeHoverExtremities: true,
            autoRescale: false
        }
    });

    $(document).bind("contextmenu", function (event) {
        event.preventDefault();
    });

    $('#base').dblclick(function (e) {
        e.stopPropagation();
    });

    $('.my-form').on('submit', function (e) {
        e.preventDefault();

        const srcNode = $("input[name='srcNode']", this).val();
        const destNode = $("input[name='destNode']", this).val();

        const sourceNodeId = s.graph.nodes().filter(function (node) {
            return node.label === srcNode
        }).shift().id;

        const destNodeId = s.graph.nodes().filter(function (node) {
            return node.label === destNode
        }).shift().id;

        calculatePath(sourceNodeId, destNodeId);
    });

    window.onload = function () {
        const storageNodes = JSON.parse(localStorage.getItem("nodes"));
        const storageEdges = JSON.parse(localStorage.getItem("edges"));

        if (storageNodes.length > 0) {
            storageNodes.forEach(function (node) {
                s.graph.addNode(node);
            });

            if (storageEdges.length > 0) {
                storageEdges.forEach(function (edge) {
                    s.graph.addEdge(edge);
                });
            }
            s.refresh();
        }
    };

    window.onbeforeunload = function () {
        localStorage.clear();

        localStorage.setItem("nodes", JSON.stringify(s.graph.nodes()));
        localStorage.setItem("edges", JSON.stringify(s.graph.edges()));
    };

    function clearGraph() {
        s.graph.clear();
        localStorage.clear();
        s.refresh();
    }

    function calculatePath(sourceNodeId, destNodeId) {

        const srcNodeColour = "#001299";
        const destNodeColour = "#991600";
        const pathColour = "#6e0db6";

        s.graph.nodes(sourceNodeId).color = srcNodeColour;
        s.graph.nodes(destNodeId).color = destNodeColour;

        const path = s.graph.dijkstra(sourceNodeId, destNodeId);

        if (path) {
            for (let i = 0; i < path.length; i++) {

                (function (index) {
                    setTimeout(function () {
                        path[index].color = pathColour;
                        s.refresh();
                    }, i * 3000)
                })(i);
            }
        } else {
            alert("NO PATH");
        }
    }
</script>
</body>
</html>
