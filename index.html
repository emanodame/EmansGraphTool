<script src="resources/node_modules/jquery/dist/jquery.min.js"></script>

<script src="resources/sigma.min.js"></script>
<script src="resources/sigma.canvas.edgehovers.def.js"></script>
<script src="resources/sigma.renderers.edgeLabels.min.js"></script>

<script src="clickFunctionality.js"></script>

<script src="algorithms/dijkstra.js"></script>
<script src="algorithms/prims.js"></script>
<script src="algorithms/kruskal.js"></script>

<script src="tools/Task.js"></script>
<script src="teachers/dijsktraTeacher.js"></script>
<script src="teachers/kruskalTeacher.js"></script>
<script src="teachers/primsTeacher.js"></script>

<script src="tools/Tree.js"></script>
<script src="resources/slideReveal.js"></script>
<script src="tourGuide.js"></script>

<link rel="stylesheet" href="resources/style.css">
<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
<link href="resources/bootstrap-tour/build/css/bootstrap-tour-standalone.css" rel="stylesheet">
<script src="resources/bootstrap-tour/build/js/bootstrap-tour-standalone.js"></script>
<script src="resources/node_modules/popup-validation/bin/validation.min.js"></script>
<link href="resources/node_modules/popup-validation/bin/validation.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="resources/style.css"/>
<script src="sigma.plugins.dragNodes.js"></script>
<link href="resources/animsition/dist/css/animsition.css" rel="stylesheet">
<script src="resources/animsition/dist/js/animsition.min.js"></script>


<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="interact.js"></script>
<script src="lol.js"></script>

<html>
<head>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <link rel="stylesheet" type="text/css" href="resources/style.css"/>
    <title>Eman's Graph Tool</title>
<body id="base">

<div id="json-import">
    <span class="close-holder"><button class="close-button" onclick="closeJsonInput()">x</button></span>
    <form id="json-input">
        <label>Input
            <input type="text" id="json-text-input" name="json-input">
            <input type="submit" class="algo-button" id="json-submit-btn" onclick="parseJson()">
        </label>
    </form>
</div>

<div id="json-export">
    <span class="close-holder"><button class="close-button" onclick="closeJsonInput()">x</button></span>
    <form id="json-output">
        <label><input type="text" id="json-text-output" name="json-input"></label>
        <input type="button" class="algo-button" id="json-copy-btn" onclick="copyJsonOutput()" value="COPY">
    </form>
</div>

<div id="tour-anchor"></div>

<div id="hover-bar"></div>

<div id="slide-revealer">
    <div class="handle">
        <span id="left-trigger" class="glyphicon glyphicon-chevron-left"></span>
        <span id="right-trigger" class="glyphicon glyphicon-chevron-right"></span>
    </div>

    <div id="slide-revealer-header">
        <div id="slide-revealer-title">
            Control Panel
        </div>
        <div id="slide-revealer-info" class="btn glyphicon glyphicon-info-sign" onclick="runTourGuide()"></div>
    </div>

    <div class="btn-group algo-button-group" role="group" aria-label="Algo Button">
        <button type="button" class="algo-button algo-chooser-highlight" id="dijkstra-option"
                onclick="showDijkstraInputBoxes()">Dijkstra's
        </button>
        <button type="button" class="algo-button" id="kruskal-option" onclick="showKruskalInputBoxes()">Kruskal's
        </button>
        <button type="button" class="algo-button" id="prim-option" onclick="showPrimsInputBoxes()">Prim's</button>
    </div>

    <form name="source-target" id="node-id-input-box" class="input-box-holder" onsubmit="executedSelectedAlgorithm()">
        <div id="source-holder">
            Source Node ID
            <label>
                <input autocomplete="off" type="text" name="source-node" id="src-node"
                       class="node-input validate-class my-class-invalid" onkeydown="enterKeyHandler()">
            </label>
            <div id="source-error-message" hidden>
                Invalid ID!
            </div>
        </div>

        <div id="button-block">
            <button type="button" class="algo-button" id="clear-button" onclick="clearGraph()">CLEAR GRAPH</button>
            <input type="submit" id="execute-button" class="algo-button" value="Execute">
        </div>
    </form>

    <div id="bottom-button-block">
        <button type="button" class="algo-button" id="random-graph-button" onclick="createRandomGraph(6)">Random
            Graph
        </button>
        <button type="button" class="algo-button " id="json-import-btn" onclick="importJson()">Import Graph</button>
        <button type="button" class="algo-button" id="json-export-btn" onclick="exportJson()">Export Graph</button>
    </div>
</div>

<div class="animsition"></div>
<div id="helper-text-container" class="resize-drag">
    <div id=helper-text></div>
</div>

<div id="media-holder">
    <span id="restart-button" class="glyphicon glyphicon-step-backward noSelect" onclick="restartProcess()"></span>
    <span id="backward-button" class="glyphicon glyphicon-backward noSelect" onclick="rewindFunctionality()"></span>
    <span id="play-button" class="glyphicon glyphicon-play noSelect" onclick="showPauseButton();play();"></span>
    <span id="pause-button" class="glyphicon glyphicon-pause noSelect" onclick="showPlayButton();pause();"></span>
    <span id="forward-button" class="glyphicon glyphicon-forward" onclick="forwardFunctionality()"></span>
    <span id="end-button" class="glyphicon glyphicon-step-forward" onclick="endProcess()"></span>
    <div id="speed-control">
        <div class="slow-btn">slow</div>
        <div id="slider" class="ui-slider-handle"></div>
        <div class="fast-btn">fast</div>
    </div>
</div>

</body>
<script>

    $(document).ready(function () {
        $('.animsition').animsition();
    });

    const helperText = document.getElementById("helper-text");

    interact('.resize-drag')
        .draggable({
            onmove: window.dragMoveListener,
            restrict: {
                restriction: 'parent',
                elementRect: {top: 0, left: 0, bottom: 1, right: 1}
            },
        })
        .resizable({
            // resize from all edges and corners
            edges: {left: true, right: true, bottom: true, top: true},

            restrictEdges: {
                outer: 'parent',
                endOnly: true,
            },
            restrictSize: {
                min: {width: 650, height: 85},
            },

            inertia: true,
        })
        .on('resizemove', function (event) {
            var target = event.target,
                x = (parseFloat(target.getAttribute('data-x')) || 0),
                y = (parseFloat(target.getAttribute('data-y')) || 0);

            // update the element's style
            target.style.width = event.rect.width + 'px';
            target.style.height = event.rect.height + 'px';

            target.style.webkitTransform = target.style.transform =
                'translate(' + x + 'px,' + y + 'px)';

            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        });

    function dragMoveListener(event) {
        var target = event.target,
            // keep the dragged position in the data-x/data-y attributes
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

        // translate the element
        target.style.webkitTransform =
            target.style.transform =
                'translate(' + x + 'px, ' + y + 'px)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }

    let speed = undefined;

    $(function () {
        $("#slider").slider({
            value: 50,
            stop: function (event, ui) {
                play(3000 - (ui.value * 25));
                showPauseButton();
            }
        });
    });

    let sticky = false;

    function showSlider() {
        $('#slide-revealer').slideReveal("show");
        document.getElementById("left-trigger").style.display = "inline";
        document.getElementById("right-trigger").style.display = "none";
        sticky = true;
    }

    function hideSlider() {
        $('#slide-revealer').slideReveal("hide");
        document.getElementById("left-trigger").style.display = "none";
        document.getElementById("right-trigger").style.display = "inline";
        sticky = false;
    }

    /*
    revisit intro page
    commonon definions and explanation page
     */
    $("#src-node").focusout(function () {
        const srcNodeId = getNodeIdFromLabel($("#src-node").val());

        if (!srcNodeId) {
            document.getElementById("source-error-message").style.display = "inline";
            validNodeId = false;
        } else {
            document.getElementById("source-error-message").style.display = "none";
            validNodeId = true;
        }
    });

    const firstTimeVisit = localStorage.getItem("first_time") === null;

    let algorithmSelected = "dijkstra";
    let validNodeId = false;

    $("#hover-bar").mouseover(function () {
        $('#slide-revealer').slideReveal("show");
        document.getElementById("left-trigger").style.display = "inline";
        document.getElementById("right-trigger").style.display = "none";
    });

    $("#slide-revealer").mouseleave(function () {
        if (!sticky) {
            $('#slide-revealer').slideReveal("hide");
            document.getElementById("left-trigger").style.display = "none";
            document.getElementById("right-trigger").style.display = "inline";
        }
    });

    function importJson() {
        document.getElementById("json-import").style.visibility = "visible";
        document.getElementById("json-export").style.visibility = "hidden";
    }

    function exportJson() {
        document.getElementById("json-import").style.visibility = "hidden";
        document.getElementById("json-export").style.visibility = "visible";

        let jsonGraphText = "{\"nodes\":";
        const nodes = [];

        s.graph.nodes().forEach(function (node) {
            const nodeCreation = {
                id: node.id,
                x: (node.x / 100).toString(),
                y: (node.y / 100).toString(),
                label: node.label
            };

            nodes.push(nodeCreation);
        });
        jsonGraphText += JSON.stringify(nodes);
        jsonGraphText += ",\"edges\":";

        const edges = [];

        s.graph.edges().forEach(function (edge) {
            const edgeCreation = {
                id: edge.id,
                source: edge.source,
                target: edge.target,
            };

            edges.push(edgeCreation);
        });

        jsonGraphText += JSON.stringify(edges);
        jsonGraphText += "}";


        document.getElementById("json-text-output").value = jsonGraphText;
    }

    function copyJsonOutput() {
        const copyText = document.getElementById("json-text-output");
        copyText.select();
        document.execCommand("Copy");
    }

    function closeJsonInput() {
        document.getElementById("json-import").style.visibility = "hidden";
        document.getElementById("json-export").style.visibility = "hidden";
    }

    function parseJson() {
        event.preventDefault();

        const jsonTextInput = document.getElementById("json-text-input").value;
        const textToJson = JSON.parse(jsonTextInput);

        clearGraph();

        for (let i = 0; i < textToJson.nodes.length; i++) {

            const nodeCreation = {
                id: textToJson.nodes[i].id,
                x: textToJson.nodes[i].x * 100,
                y: textToJson.nodes[i].y * 100,
                label: textToJson.nodes[i].label ? textToJson.nodes[i].label : textToJson.nodes[i].id.toString(),
                size: 10
            };

            s.graph.addNode(nodeCreation);
            s.refresh();
            closeJsonInput();
        }

        for (let i = 0; i < textToJson.edges.length; i++) {

            const edgeCreation = {
                id: createEdgeIdFromCoordinates(textToJson.edges[i].source, textToJson.edges[i].target),
                source: textToJson.edges[i].source,
                target: textToJson.edges[i].target,
                defaultEdgeLabelSize: 20,
                size: 3,
                label: textToJson.edges[i].weight
            };

            s.graph.addEdge(edgeCreation);
            s.refresh();
        }
    }

    function restartProcess() {
        showPlayButton();
        pause();

        switch (localStorage.getItem("algorithm")) {
            case "dijkstra":
                executeDijkstraTeacher.restart();
                break;

            case "kruskal":
                executeKruskalTeacher.restart();
                break;

            case "prim":
                executePrimsTeacher.restart();
                break;
        }
    }

    function showPlayButton() {
        document.getElementById("pause-button").style.display = "none";
        document.getElementById("play-button").style.display = "inline";
    }

    function showPauseButton() {
        document.getElementById("play-button").style.display = "none";
        document.getElementById("pause-button").style.display = "inline";
    }


    function play(intervalTime) {
        switch (localStorage.getItem("algorithm")) {
            case "dijkstra":
                executeDijkstraTeacher.play(intervalTime);
                break;

            case "kruskal":
                executeKruskalTeacher.play(intervalTime);
                break;

            case "prim":
                executePrimsTeacher.play(intervalTime);
                break;
        }
    }

    function pause() {
        switch (localStorage.getItem("algorithm")) {
            case "dijkstra":
                executeDijkstraTeacher.pause();
                break;

            case "kruskal":
                executeKruskalTeacher.pause();
                break;

            case "prim":
                executePrimsTeacher.pause();
                break;
        }
    }

    function rewindFunctionality() {
        showPlayButton();
        pause();

        switch (localStorage.getItem("algorithm")) {
            case "dijkstra":
                executeDijkstraTeacher.rewind();
                break;

            case "kruskal":
                executeKruskalTeacher.rewind();
                break;

            case "prim":
                executePrimsTeacher.rewind();
                break;
        }
    }

    function forwardFunctionality() {
        showPlayButton();
        pause();

        switch (localStorage.getItem("algorithm")) {
            case "dijkstra":
                executeDijkstraTeacher.forward();
                break;

            case "kruskal":
                executeKruskalTeacher.forward();
                break;

            case "prim":
                executePrimsTeacher.forward();
                break;
        }
    }

    function endProcess() {
        showPlayButton();
        pause();

        switch (localStorage.getItem("algorithm")) {
            case "dijkstra":
                executeDijkstraTeacher.end();
                break;

            case "kruskal":
                executeKruskalTeacher.end();
                break;

            case "prim":
                executePrimsTeacher.end();
                break;
        }
    }

    $('#slide-revealer').slideReveal({
        trigger: $("#left-trigger"),
        position: "right",
        push: false,
        overlay: true
    });


    function enterKeyHandler() {
        if (event.keyCode === 13) {
            executedSelectedAlgorithm()
        }
    }

    function showDijkstraInputBoxes() {
        document.getElementById("source-holder").style.visibility = "visible";

        $(".algo-chooser-highlight").removeClass("algo-chooser-highlight");
        $('#dijkstra-option').addClass('algo-chooser-highlight');
        algorithmSelected = "dijkstra";
    }

    function showKruskalInputBoxes() {
        document.getElementById("source-holder").style.visibility = "hidden";

        $(".algo-chooser-highlight").removeClass("algo-chooser-highlight");
        $('#kruskal-option').addClass('algo-chooser-highlight');

        algorithmSelected = "kruskal";
    }

    function showPrimsInputBoxes() {
        document.getElementById("source-holder").style.visibility = "visible";

        $(".algo-chooser-highlight").removeClass("algo-chooser-highlight");
        $('#prim-option').addClass('algo-chooser-highlight');

        algorithmSelected = "prim";
    }


    $(document).bind("contextmenu", function (event) {
        event.preventDefault();
    });

    $(document).ondblclick = function (event) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    };

    const nodeColour = "#ff0e58";
    const edgeColour = "#ff0e58";

    const s = new sigma({
        renderer: {
            container: document.getElementById('base'),
            type: 'canvas',
        },
        settings: {
            borderSize: 3,

            defaultNodeColor: nodeColour,
            defaultNodeBorderColor: "#c9ddff",

            defaultEdgeColor: edgeColour,
            defaultEdgeLabelColor: edgeColour,
            defaultEdgeLabelSize: 20,

            defaultLabelColor: "#ffffff",
            defaultLabelHoverColor: "#ff0e58",
            labelHoverColor: "node",
            labelShadowColor: "#c9ddff",

            enableEdgeHovering: true,
            edgeHoverSizeRatio: 2,
            edgeHoverExtremities: true,
            autoRescale: false,
            mouseEnabled: true,
            doubleClickEnabled: false
        }
    });

    s.camera.x = localStorage.getItem("cameraX");
    s.camera.y = localStorage.getItem("cameraY");
    const dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);

    window.onload = function () {
        const storageNodes = JSON.parse(localStorage.getItem("nodes"));
        const storageEdges = JSON.parse(localStorage.getItem("edges"));

        if (storageNodes.length > 0) {
            storageNodes.forEach(function (node) {
                s.graph.addNode(node);
            });

            if (storageEdges.length > 0) {
                storageEdges.forEach(function (edge) {
                    s.graph.addEdge(edge);
                });
            }
            s.refresh();
        }
    };

    window.onbeforeunload = function () {
        clearColoredNodesAndEdges();
        localStorage.clear();

        localStorage.setItem("nodes", JSON.stringify(s.graph.nodes()));
        localStorage.setItem("edges", JSON.stringify(s.graph.edges()));

        localStorage.setItem("cameraX", s.camera.x);
        localStorage.setItem("cameraY", s.camera.y);
    };

    function createRandomGraph(quantityOfNodes) {
        clearGraph();

        let labelId = 0;

        const nodeIdSet = new Set();

        for (let i = 0; i < quantityOfNodes; i++) {

            let randomGeneratedX = Math.floor(Math.random() * 5) + 1;
            randomGeneratedX *= Math.floor(Math.random() * 2) === 1 ? 1 : -1;

            let randomGeneratedY = Math.floor(Math.random() * 5) + 1;
            randomGeneratedY *= Math.floor(Math.random() * 2) === 1 ? 1 : -1;


            const nodeId = createNodeIdFromCoordinates(randomGeneratedX, randomGeneratedY);

            if (!nodeIdSet.has(nodeId)) {
                s.graph.addNode({
                    id: createNodeIdFromCoordinates(randomGeneratedX, randomGeneratedY),
                    x: randomGeneratedX * 100,
                    y: randomGeneratedY * 100,
                    label: (labelId++).toString(),
                    size: 10
                });

                nodeIdSet.add(nodeId);
            }
        }

        const nodesOnGraph = s.graph.nodes();

        const edgeIdSet = new Set();

        for (let node of nodesOnGraph) {
            const pickRandomNodeToConnect = Math.floor(Math.random() * nodesOnGraph.length);

            const sourceNode = node;
            let targetNode = nodesOnGraph[pickRandomNodeToConnect];

            while (sourceNode === targetNode) {
                targetNode = nodesOnGraph[Math.floor(Math.random() * nodesOnGraph.length)];
            }

            const edgeId = createEdgeIdFromCoordinates(sourceNode.id, targetNode.id);

            if (!edgeIdSet.has(edgeId)) {
                s.graph.addEdge({
                    id: edgeId,
                    source: sourceNode.id,
                    target: targetNode.id,
                    defaultEdgeLabelSize: 20,
                    size: 3,
                    label: computePathLength(sourceNode, targetNode).toString()
                });

                edgeIdSet.add(edgeId);
            }
        }
        s.refresh();
    }

    function executedSelectedAlgorithm() {
        $("#helper-text-container").fadeIn();
        event.preventDefault();

        if (algorithmSelected === "dijkstra") {

            if (!validNodeId) {
                document.getElementById("source-error-message").style.display = "inline";
                validNodeId = false;
                return false;
            } else {
                validNodeId = true;
                clearColoredNodesAndEdges();
                calculateDijkstraPath();
            }

        } else if (algorithmSelected === "kruskal") {
            validNodeId = true;
            clearColoredNodesAndEdges();
            calculateKruskalPath();

        } else if (algorithmSelected === "prim") {

            if (!validNodeId) {
                document.getElementById("source-error-message").style.display = "inline";
                validNodeId = false;
                return false;
            } else {
                validNodeId = true;
                clearColoredNodesAndEdges();
                calculatePrimsPath();
            }
        }

        return false;
    }

    function calculateDijkstraPath() {
        if (validNodeId) {
            localStorage.setItem("algorithm", "dijkstra");

            const srcNodeId = getNodeIdFromLabel($("#src-node").val());

            const path = s.graph.dijkstra(srcNodeId);
            executeDijkstraTeacher(path);

            $('#slide-revealer').slideReveal("hide");
            document.getElementById("play-button").style.display = "inline";
            document.getElementById("pause-button").style.display = "none";
        }
    }

    function calculateKruskalPath() {
        localStorage.setItem("algorithm", "kruskal");

        const idsOfMinSpanningTreeEdges = s.graph.kruskal();
        executeKruskalTeacher(idsOfMinSpanningTreeEdges);

        $('#slide-revealer').slideReveal("hide");
        document.getElementById("play-button").style.display = "inline";
        document.getElementById("pause-button").style.display = "none";
    }

    function calculatePrimsPath() {
        localStorage.setItem("algorithm", "prim");

        const srcNodeId = getNodeIdFromLabel($("#src-node").val());

        const edgesWithMinSpanTreeFlag = s.graph.prims(srcNodeId);
        executePrimsTeacher(edgesWithMinSpanTreeFlag);

        $('#slide-revealer').slideReveal("hide");
        document.getElementById("play-button").style.display = "none";
        document.getElementById("pause-button").style.display = "inline";
    }

    function clearGraph() {
        s.graph.clear();
        localStorage.clear();
        s.refresh();
    }

    function clearColoredNodesAndEdges() {
        s.graph.nodes().forEach(function (node) {
            node.color = nodeColour;
        });

        s.graph.edges().forEach(function (edges) {
            edges.color = nodeColour;
        });

        s.refresh();
    }

    function getNodeIdFromLabel(nodeId) {
        const node = s.graph.nodes().filter(function (node) {
            return node.label === nodeId;
        }).shift();

        return node ? node.id : null;
    }

    const createNodeIdFromCoordinates = function (x, y) {
        return x + '.' + y;
    };

    function createEdgeIdFromCoordinates(x, y) {
        return x + "|" + y;
    }

    function computePathLength(node1, node2) {
        return (Math.sqrt(Math.pow((node2.y - node1.y), 2) + Math.pow((node2.x - node1.x), 2)) / 10).toFixed(2);
    }

    function returnSortedEdgesByWeight() {
        return s.graph.edges().sort(function (a, b) {
            return a.label - b.label;
        });
    }
</script>

</html>